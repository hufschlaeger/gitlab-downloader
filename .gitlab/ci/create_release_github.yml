create_github_release:
  image: alpine:latest
  tags: [docker]
  stage: release
  before_script:
    - apk add --no-cache git curl jq
    - git fetch --tags
  script:
    - |
      # 1. Version bestimmen (Tag oder Fallback)
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="$CI_COMMIT_TAG"
      else
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        COMMIT_SHORT=$(git rev-parse --short=8 HEAD)
        VERSION="$LAST_TAG-$COMMIT_SHORT"
      fi
      echo "Creating GitHub release for version: $VERSION"

    - |
      # 2. Release-Notizen generieren
      PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
      if [ -n "$PREVIOUS_TAG" ]; then
        CHANGELOG=$(git log --pretty=format:"- %s" "${PREVIOUS_TAG}..HEAD" | grep -v "Merge")
      else
        CHANGELOG=$(git log --pretty=format:"- %s" HEAD~10..HEAD | grep -v "Merge")
      fi
      
      # JSON-sichere Release Notes erstellen
      RELEASE_BODY=$(cat <<EOF
      # Release $VERSION
      
      ## Changes
      $CHANGELOG
      
      ## Downloads
      See assets below for binaries.
      EOF
      )

    - |
      # 3. GitHub Release erstellen
      RESPONSE=$(curl -X POST \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${GITHUB_TOKEN}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        https://api.github.com/repos/${GITHUB_REPO}/releases \
        -d "$(jq -n \
          --arg tag "$VERSION" \
          --arg name "Release $VERSION" \
          --arg body "$RELEASE_BODY" \
          --arg commit "${CI_COMMIT_SHA}" \
          '{
            tag_name: $tag,
            name: $name,
            body: $body,
            draft: false,
            prerelease: false,
            target_commitish: $commit
          }')")
      
      echo "$RESPONSE"
      RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
      echo "RELEASE_ID=$RELEASE_ID" > github_release.env

    - |
      # 4. Binaries als Assets hochladen
      for file in bin/gitlab-downloader-*; do
        if [ -f "$file" ]; then
          filename=$(basename "$file")
          echo "Uploading $filename..."
      
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@$file" \
            "https://uploads.github.com/repos/${GITHUB_REPO}/releases/${RELEASE_ID}/assets?name=${filename}"
        fi
      done

  artifacts:
    paths:
      - github_release.env
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'
  dependencies:
    - build_project
