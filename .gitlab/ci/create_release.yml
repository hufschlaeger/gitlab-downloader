create_release:
  image: registry.gitlab.com/gitlab-org/cli:latest
  tags: [docker]
  stage: release
  before_script:
    - apk add --no-cache git
    - git fetch --tags
    # glab konfigurieren
    - glab auth login --hostname ${CI_SERVER_HOST} --token ${RELEASE_TOKEN}
    - glab config set --global host ${CI_SERVER_HOST}
  script:
    - |
      # 1. Version bestimmen (Tag oder Fallback)
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="$CI_COMMIT_TAG"
      else
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        COMMIT_SHORT=$(git rev-parse --short=8 HEAD)
        VERSION="$LAST_TAG-$COMMIT_SHORT"
      fi
      echo "VERSION=$VERSION" > release.env

    - |
      # 2. Release-Notizen generieren
      PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
      if [ -n "$PREVIOUS_TAG" ]; then
        CHANGELOG=$(git log --pretty=format:"- %s" "${PREVIOUS_TAG}..HEAD" | grep -v "Merge")
      else
        CHANGELOG=$(git log --pretty=format:"- %s" HEAD~10..HEAD | grep -v "Merge")
      fi
      
      {
        echo "RELEASE_NOTES<<EOF"
        echo "# Release $VERSION"
        echo ""
        echo "## Changes"
        echo "$CHANGELOG"
        echo ""
        echo "## Assets"
        echo "- [Linux Binary]($CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/releases/gitlab-downloader-linux-amd64.tar.gz)"
        echo "- [macOS Binary]($CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/releases/gitlab-downloader-darwin-amd64.tar.gz)"
        echo "EOF"
      } >> release.env

    - |
      # 3. Release erstellen (offizielle Syntax)
      glab release create "$VERSION" \
        --repo "$CI_PROJECT_PATH" \
        --name "Release $VERSION" \
        --notes "$(awk '/RELEASE_NOTES<<EOF/{flag=1;next}/EOF/{flag=0}flag' release.env)" \
        --ref "${CI_COMMIT_SHA}"

    - |
      # 4. Asset-Links hinzufÃ¼gen
      glab api --method POST \
        "/projects/${CI_PROJECT_ID}/releases/${VERSION}/assets/links" \
        -f name="Linux Binary (amd64)" \
        -f url="${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/releases/gitlab-downloader-linux-amd64.tar.gz" \
        -f link_type="package" || true
      
      glab api --method POST \
        "/projects/${CI_PROJECT_ID}/releases/${VERSION}/assets/links" \
        -f name="macOS Binary (amd64)" \
        -f url="${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/releases/gitlab-downloader-darwin-amd64.tar.gz" \
        -f link_type="package" || true
      
      glab api --method POST \
        "/projects/${CI_PROJECT_ID}/releases/${VERSION}/assets/links" \
        -f name="macOS Binary (arm64)" \
        -f url="${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/releases/gitlab-downloader-darwin-arm64.tar.gz" \
        -f link_type="package" || true

      glab api --method POST \
        "/projects/${CI_PROJECT_ID}/releases/${VERSION}/assets/links" \
        -f name="Windows Binary (amd64)" \
        -f url="${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/releases/gitlab-downloader-windows-amd64.zip" \
        -f link_type="package" || true

    - mkdir -p releases && cp bin/gitlab-downloader-* releases/ 2>/dev/null || true
  artifacts:
    paths:
      - releases/
    expire_in: 4 weeks

  rules:
    - if: '$CI_COMMIT_TAG'

  dependencies:
    - build_project
